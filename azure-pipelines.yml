trigger:
  branches:
    include:
      - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  MAVEN_OPTS: "-Dmaven.compiler.source=17 -Dmaven.compiler.target=17"

stages:

  - stage: Build
    displayName: 'ğŸ”§ Build Stage'
    jobs:
      - job: BuildJob
        displayName: 'Instalar dependÃªncias e Chrome'
        steps:

          - task: Cache@2
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
              path: $(HOME)/.m2/repository

          - script: |
              sudo apt-get update
              sudo apt-get install -y google-chrome-stable
            displayName: 'Install Google Chrome'

          - script: |
              google-chrome --version
            displayName: 'Show Chrome version'

  - stage: Test
    displayName: 'ğŸ§ª Test Stage'
    dependsOn: Build
    jobs:
      - job: RunTests
        displayName: 'Executar testes com Maven'
        steps:
          - script: mvn -B test --fail-at-end -Dsurefire.printSummary=true
            displayName: 'Run Maven tests'

          - script: |
              echo "ğŸ“‚ ConteÃºdo da pasta target:"
              ls -R target
              displayName: 'ğŸ“‚ Verificar arquivos gerados'
          - script: |
              echo "ğŸ§ª Verificando conteÃºdo do XML"
              cat target/surefire-reports/TEST-*.xml
            displayName: 'ğŸ” Confirmar arquivos XML'

  - stage: Report
    displayName: 'ğŸ“Š Report Stage'
    condition: succeededOrFailed()
    dependsOn: Test
    jobs:
      - job: PublishResults
        displayName: 'Publicar relatÃ³rios JUnit'
        steps:
          - task: PublishTestResults@2
            inputs:
              testResultsFiles: 'target/surefire-reports/TEST-*.xml'
              testResultsFormat: 'JUnit'
              failTaskOnFailedTests: true
              failTaskOnMissingResultsFile: true
              testRunTitle: 'Test Report'
